<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.codingjoa.mapper.AdminMapper">

	<select id="findBoardInfo" parameterType="map" resultMap="boardInfoMap">
		SELECT 
			a.board_idx,
			a.board_title, 
			a.board_content, 
			a.board_views, 
			a.board_category_code, 
			a.created_at, 
			a.updated_at,
			b.member_nickname AS board_writer_nickname,
			NVL(c.cnt, 0) AS comment_cnt,
    		NVL(d.cnt, 0) AS board_likes_cnt,
    		CASE
    			WHEN a.board_writer_idx = #{memberIdx} THEN 1
    			ELSE 0
    		END AS is_board_writer,
    		CASE
    			WHEN EXISTS ( 
    				SELECT 1 
    				FROM board_likes e 
    				WHERE e.board_idx = a.board_idx 
    				AND e.member_idx = #{memberIdx} 
    			) THEN 1
    			ELSE 0
    		END AS is_board_liked
		FROM
			board a
		INNER JOIN
			member b
		ON
			a.board_writer_idx = b.member_idx
		LEFT OUTER JOIN (
			SELECT 
				board_idx, 
				COUNT(*) cnt
			FROM
				"comment"
			GROUP BY 
				board_idx
		) c
		ON 
			a.board_idx = c.board_idx
		LEFT OUTER JOIN ( 
			SELECT 
    			board_idx,
    			COUNT(*) cnt
    		FROM 
    			board_likes
    		GROUP BY 
				board_idx
    	) d
		ON 
			a.board_idx = d.board_idx
		WHERE
			a.board_idx = #{boardIdx} 
	</select>
</mapper>